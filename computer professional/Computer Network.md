# Computer Network
## Introduction
### 网络协议层次结构
OSI七层参考模型：
- 应用层
- 表示层
- 会话层
- 运输层
- 网络层
- 数据链路层
- 物理层

常见教学五层结构：
- 应用层
- 运输层
- 网络层
- 数据链路层
- 物理层

实际Internet四层结构：
- 应用层
- 运输层
- 网络层
- 物理网络层

应用层：
- 为*专门的应用*提供服务
- 传输单位为Message（报文、消息）
- 协议非常多，比如：
  - HTTP: Web
  - SSL/TLS: Security
  - SMTP/POP3: Email
  - DNS
  - FTP: File
  - DHCP: Configuration
- 由于Unix风格和历史原因，应用层协议偏好*基于文本*的形式

表示层：
- 数据的表示、压缩、转换、加密
- 对标HTTP *Accept-Encoding*与SSL/TLS

会话层
- 提供会话功能（比如IP电话、视频）
- 对标RTMP、RTP等流媒体传输协议

传输层（运输层）：
- 提供*进程与进程*之间的通信
- 传输单位为Segment（报文段）
- TCP、UDP
- 这一层的TCP可以提供*有连接*、*有确认*的*可靠传输服务*

网络层（网际层）：
- 提供*主机与主机*之间在*互连网络*中的通信
- 传输单位为Datagram（数据报）
- 最重要的功能其实是**路由选择**
- IP协议的提供的服务是*无连接*的*不可靠服务（尽最大努力交付服务）*
- 协议：
  - 代表性协议是*IP*
  - 路由选择协议
    - RIP
    - OSPF
    - BGP
  - ICMP
- IP协议实际上是因特网协议族的最底层，**物理网络层不属于因特网协议族**。这是因为**IP协议连接的物理网络的各个子网可以是异构的**，或者说互连网络连接的各个子网可以采用不同的链路层协议和物理层协议

数据链路层：
- 提供主机与主机之间在*直连网络*中的通信
- 传输单位为Frame（帧）
- 负责数据的校验
- 协议：
  - PPP（点到点）
  - Ethernet（多路访问网络）
  - ARP（基于MAC地址的链路层通信）

### Concepts
- SAN, LAN, MAN, WAN
  
  SAN: System Area Network
  
- Internet
  
  Internet = Host + Link + Router

- PDU, SDU, PCI, SAP
  - PDU: Protocol Data Unit，也即包（Packet）
  - SDU: Service Data Unit; PCI: Protocol Control Information，一般作为header
  - PDU = PCI + SDU
  - SAP: Service Access Point

- 时延：
  - 处理时延：与路由器处理性能有关
  - 排队时延：与拥塞有关
  - 传输时延：与通信链路带宽有关
  - 传播时延：
    - 与通信介值、通信距离有关
    - 注意**光纤的传播时延大于铜线**

## 信道复用

- Multiplex
  - FDM: Frequency Division Multiplex
  - TDM/WDM: Time/Wave Division Multiplex
  - CDM: Code Division Multiplex (3G: CDMA)
  - Statistical Multiplex

- Switching
  - Circuit Switching: FDM,TDM,CDM, Telephone 
  - **Packet Switching**: Statistical Multiplex, Computer Network

## 数据链路层

提供在**直连网络**上节点之间的通信服务

四个主要功能：
- framing 形成帧
  - 在header中包含校验码、地址、和SAP（指名帧的上层协议）
- error detect 差错检验、纠错
- error control 发现丢包、重复、错序、溢出，提供流量控制
  - 注：这些特性用于提供可靠传输服务，但并不是所有的链路层协议都提供可靠传输服务的，所有这些功能不一定有（互联网络中的可靠传输服务由TCP提供，毕竟IP协议是不可靠传输协议）
- medium access control 介值访问控制
  - 用于处理多路访问网络（比如以太网）中的碰撞问题

### Error Detect
- Parity 奇偶校验码
  - 保证传输比特和校验位中1的个数为偶数/奇数（偶校验/）
  - 可以将原始的包数据排列成二维矩阵，然后采用二维的奇偶校验码即可实现检错和一位纠错
  - 可以拓展为*海明码*
- CheckSum 检验和
  - 利用加法器，将传输比特流分段相加再取反得到校验和
  - 加法过程中的进位还要单独加一次
  - 传输比特+校验和得到全1码
  - 由于依赖加法，且是弱校验，一般不用于链路层，而是用于网络层和传输层
- CRC 循环冗余校验
  - 利用*生成多项式*和*模2除法*实现
  - 硬件实现简单高效
  - 检错率很高

### Reliable Data Transfer (Link ver.)
需要分类讨论：点到点和多路访问网络。因为点到点网络的情形相对简单：不会原生出现重复、错序和碰撞，主要会发生丢包错误

点到点：
- 接收方使用序号来发现中间的丢包（由于点到点网络不会错序到达，所有中间确实的编号必然是丢了）
- 接收方收到的包检验出错（且无法纠错），则丢弃该包，相当于该包丢失了
- 发送方等待接收方的*确认帧*，若某一个包没有确认，则认为该包丢失了，需要*重传*
- 由于接收方无法检出所有的丢包（比如序号最后的连续若干个包丢失），所以不能简单地等待接收方对所有发出的包进行确认
- 正确的做法是为每个发送的帧设置*超时计时器*，一旦超时视为丢包，进行**超时重传**
- ARQ：自动重传
  - 两种策略：停止等待协议，连续确认协议
  - 停止等待协议
    - 每次发送一帧，然后等待确认，发送成功收到确认才发送下一帧，否则重传
    - 较简单，但效率非常低，因为必须等待确认才能发送下一帧（尤其是在传播时延较大的信道）
  - 可能出现的问题&解决方案
    - 帧丢失/帧校验出错
      
      发送方超时重传，接收方等待重传
  
    - 确认帧丢失
      
      发送方超时重传，接收方收到重复帧（丢弃重复），发出重复确认
  
    - 帧迟到/确认帧迟到
      
      发送方超时重传，接收方收到重复帧（丢弃重复），发出重复确认（丢弃重复），发送方收到重复确认
- 连续ARQ

  连续ARQ是指可以连续发送多个帧，不必等待确认

  - 滑动窗口协议
    - 发送窗口：通过划定发送方连续传输的最大边界来实现流量控制
    - 当发送窗口中的帧得到确认时可以将窗口右移，表示后续的帧可以继续发送了
    - 一般采用*累计确认*的方法，即收到确认号n表示序号n及其之前的全部帧都已收到
  
  若第n帧丢失，但n+1帧开始正常收到（也即*错序到达*），有两种策略：

  - Go Back N

    第n帧丢失，则从第n帧开始重传（尽管n+1帧以后的已经收到了），然后丢弃重复收到的帧

  - Selective Repeat

    增加否定性确认确认帧（NAK），表示n之前的全部帧都已收到，但第n帧丢失了。

    发现这种丢失时，接收方暂存错序到达的帧，并发送NAK

    在这种策略下，超时时间将适当增大（比如2RTT），只重传丢失的帧，并最终在收到适合的累积确认ACK后避免重传n+1开始错序到达的帧

    在信道较差的情况下，这种策略会有负面影响（超时时间增大，重传延迟）

    为了暂存错序到达的帧，接收方需要接收窗口

    注意，在该策略下接收窗口大小<=发送窗口
  
  改进滑动窗口：
  - SACK 选择确认：选择错序到达的帧进行确认，减少重传
  - Delay ACK 延迟确认：在接收到一帧后不立即发确认，等一段时间再发确认。由于基于累计确认机制，可以少发一些ACK
  - 捎带确认。由于是全双工通信，在接收方发数据的同时捎带上ACK

### PPP
PPP = Point-to-Point Protocol

PPP协议是一种用于**点到点网络**的数据链路层协议。

PPP提供的是**不可靠传输服务**

PPP数据帧
```
  标志 地址 控制 协议 数据 校验码 标志
```
- 标志规定是0x7E
- 地址固定为0xFF, 控制固定为0x03


透明传输问题：
- 作为链路层协议，PPP帧的定界依赖帧开头和结尾的**0x7E标志**。但是SDU中有可能本来就有0x7E，故为了实现*透明传输*，需要对SDU数据中的0x7E来进行*转义*

PPP协议的协商：

PPP协议允许通信双方对通信细节进行“协商”

### NIC

NIC(Network Interface Card)，网络接口卡，俗称“网卡”。

链路层主要通过NIC及其驱动程序来实现的。

### 多路访问网络&介值访问控制协议

多路访问链路也称广播链路，指一组主机共享同一传输介质。广播链路的好处是节省线材，容易支持广播；缺点是一旦有多台主机同时发送会导致链路中的信号相互干扰，称为*碰撞*

为了解决广播链路的冲突问题，一些专门由于处理广播链路冲突的协议称为**MAC(Media Access Control)**协议

目前，在多路访问链路中常将数据链路层细分为*LLC(Logic Link Communication)*层和*MAC(Media Access Control)*层

最著名的的多路访问网络协议是**以太网(Ethenet)**

Slotted：一种MAC策略，规定将时间分为若干等长的片，称为“槽（slot）”。帧只能在slot的开始发送，也即*将发送时机同步到slot起始时刻*.可以证明这一策略能提高效率减少碰撞。

历史上曾经出现过Slotted ALOHA协议，不进行载波监听直接发送，冲突则重传，效率是较一般的。

CSMA
- CSMA = Carrier Sense Multiple Access 载波监听多路访问
- 这是一种MAC策略，是指**发送前，需要监听信道是否空闲**
- 几种具体的CSMA：
  -  1-persistent CSMA （以太网采用）
     
     发送前先监听信道，信道空，立即发送；否则持续监听，直到信道空，立即发送
  
  -  non-persistent CSMA （常见于低功耗的场景）
     
     (1) 发送前先监听信道，信道空，立即发送；(2) 否则延迟一段随机长度的时间，转(1)
  
  - p-persistent CSMA

    类似1-persistent CSMA，但是在信道空的时候以概率p发送（区别于以概率1发送）

CSMA/CD协议
- 全称 Carrier Sense Multiple Access Collision Detection
- 是以太网使用的MAC协议
- **CSMA/CD基本流程**：
  - 1-persistent CSMA, 信道空立即发送，否则持续监听至信道空再发送
  - 边发送边检测冲突，如果发送完毕都没有检测到冲突，则发送成功
  - 若发送时检测到冲突，则停止发送并发送32bit干扰位加强冲突信号
  - 冲突发生时采用*二进制指数退避算法*随机延迟一段时间再回到1-persistent
- 监听信道的时候，必须要有一段连续时间的空闲才能算空闲。比如96b。
- 二进制指数退避算法
  
  基本做法：在第$i$次冲突时随机延迟$k$个时间片，其中$k\in Z$从区间$[0, 2^{\min(i, 10)-1}]$中随机选取。
  
  注意：
  - 第10次之后不再增大选取范围，因此该算法也称*截断式*二进制指数退避算法
  - 第16次冲突之后将不再重试，直接向上层返回发送失败。

  第$i$次冲突概率：
  $$
    \begin{cases}
    \frac{1}{2^{i-1}},\ i \le 10\\
    \frac{1}{2^9},\ i > 10
    \end{cases}
  $$

  冲突次数期望：
  $$

  $$

### 以太网
以下内容为10Mbps以太网协议的规定


以太网MAC帧格式
```
  前导字符 目的地址 源地址 类型/长度 有效载荷 帧校验序列
```
- 前导字符包括7B的*同步字符*和1B的*起始定界符*，这一部分可以不视为帧的一部分
- 目的地址就是MAC地址
- 源地址也是MAC地址
- “类型/长度”字段
  - 该字段存在历史包袱
    - DIXv2格式：最初的格式，在该格式中该字段表示“类型”
    - 802.3帧（原）：该字段表示“长度”
    - 802.3帧（1997年修订）：也是现在的格式，表示类型/长度
  - 该字段原本表示的是上层协议类型，即SAP
  - 但有效载荷是变长的，且*最小长度是46B，不足的字节会填充*，不得不使用该字段表示有效载荷的真实长度
  - 但幸好，表示SAP的数值都大于1500（有效载荷最大长度）
  - 综上，使用如下表示规则：
    - 若该字段大于1500，则将其解释为SAP
    - 若该字段不足1500，则将其解释为有效载荷实际长度
    - 但这一策略仍然有问题：当类型/长度字段表示长度时将无法表示SAP。解决方案是增加抽象层次，拓展帧格式，在有效载荷中继续添加header以表示SAP
  - 实际上，目前的网卡实现基本都不会将该字段解释为长度，基本用不到那个复杂的拓展格式。也即**现在的以太网实现总是将“类型/长度”字段解释为SAP**，**由上层协议保证帧有效载荷长度不小于1500**
- 帧校验序列是CRC-32

关于以太网MAC地址：
  - MAC地址6B，分为三种：单播地址、多播地址、广播地址
  - 单播地址也称物理地址，一个网卡需要绑定唯一的MAC单播地址（网卡出厂时厂商保证MAC地址唯一）。但实际上网卡的MAC地址可以更改，且只需要在同一以太网中唯一即可。
  - 广播地址全1
  - 由于以太网实际上是广播信道，以太网网卡是会接收所有正确的帧的，对于单播/多播，网卡检查目标地址是否符合，

最短帧问题
- 问题出在以太网*边发送边检测冲突*，换句话说*不发送不检测冲突*。
- 由于传播时延，一个节点从发送到其冲突传播回到节点**至多需要2RTT**。为了保证当冲突到达发送端的时候发送端仍在检测冲突（也即*仍在发送*），必须根据网络带宽设置*最小有效载荷长度*，从而保证*最小帧长度*，保证在2RTT之内节点仍在发送。以10Mbps以太网为例，2RTT约等于51.2微秒，对应的最小帧长度是64B

**争用窗口**：
- 使用符号$\tau$表示
- 通常$\tau=2\mathrm{RTT}$。
- 争用窗口的意义是：若信道空闲，某主机准备发送数据，则在长度$\tau$的时间内，是有可能与其他节点产生冲突的。通俗地说，这一窗口内有可能出现相互*争用*信道导致冲突。
- 一般CSMA/CD的退避算法的延迟时间片也是$\tau$。这是因为如果退避时间片小于争用窗口



### 以太网的物理设备
- 最初的同轴电缆
  
  这种方案是真正意义上的完全共用物理介值。

  一台主机故障，整个网络的无法工作。早已淘汰。

- 集线器

  这种设备的行为就是简单地模拟同轴电缆总线的功能：收到信号立刻转发至所有其他线路，收到冲突则转发冲突。

  **集线器没有存储转发的功能**。从这一意义上说，集线器工作在物理层上（面向比特传输）。

  **集线器的所有接口共用同一个冲突域**。也即集线器连接的任何两个同时发送则会冲突。

  现已很少用了

- 交换机
  
  - **交换机具有存储转发的功能**
  - 交换机的各个端口**各自属于不同的冲突域**。这是因为交换机能够存储转发，检查目标地址，只将帧转发到合适的端口，故端口之间不会冲突

### 扩展局域网
- 透明网桥
  - 用*网桥*连接若干个LAN可以建造一个更大的LAN，称为桥接局域网或者扩展局域网。
  - 原来的局域网称为扩展局域网的一部分，称为该局域网的一个网段（Segment）
  - 由于网桥对局域网的拓展对主机是不可见的，换句话说，对于主机来讲拓展局域网仍然是一个局域网，具有统一的操作接口和协议。因此这样对主机透明的网桥设备也称为*透明网桥*
  - 网桥工作在链路层，因为网桥面向帧进行工作。
  - 网桥对应的产品恰恰是**交换机**
  - 网桥的三种操作
    - flood：若某一网段的主机*广播*信息，网桥广播其发送帧到所有端口，同时**不能将其发回发送信息的网段本身**，因此这一操作并不是真正的广播，称为泛洪（flood）
    - forward：若某一网段的主机*单播*信息，且目标主机是*另一个网段*的，则网桥需要将信息转发（forward）目标主机所在的端口。
    - discard：若某一网段的主机单播信息，且目标主机是*同一网段*的，则网桥不做任何转发操作，简单地丢弃（discard）收到的帧即可。
  - 网桥需要维护一个表记录各个主机所在网段，该表称为转发表。
  - 转发表的*自学习*
    - 转发表具有*自学习*特性，每次主机发送帧的时候根据帧的源地址字段，自动记录该主机所属网段
    - 新入网的主机可能在转发表中没有记录，若此时有主机向该新入网主机的发送信息，网桥会直接flood该帧
    - 由于网络拓扑结构可能会变化（比如一台已经有记录的主机从一个网段转移至另一个网段），转发表的记录可能会*过期*。因此网桥会为每一条记录设置TTL（生存时间）。当记录过期时，网桥将该记录删除。
    - 因此，完整的网桥自学习策略是：
      - 当收到一帧，若源地址没有记录，则添加转发表记录；若源地址对应记录已存在，则**更新转发表记录，重置TTL**
      - 当一条记录超时了，删除该记录
    - 实际上，由于实际的网络中的主机总是在发送帧，这一策略往往可以保证转发表对网络的拓扑结构是最新的。
  - 多网桥与广播风暴