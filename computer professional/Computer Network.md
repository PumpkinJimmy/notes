# Computer Network
## Introduction
### 网络协议层次结构
OSI七层参考模型：
- 应用层
- 表示层
- 会话层
- 运输层
- 网络层
- 数据链路层
- 物理层

常见教学五层结构：
- 应用层
- 运输层
- 网络层
- 数据链路层
- 物理层

实际Internet四层结构：
- 应用层
- 运输层
- 网络层
- 物理网络层

应用层：
- 为*专门的应用*提供服务
- 传输单位为Message（报文、消息）
- 协议非常多，比如：
  - HTTP: Web
  - SSL/TLS: Security
  - SMTP/POP3: Email
  - DNS
  - FTP: File
  - DHCP: Configuration
- 由于Unix风格和历史原因，应用层协议偏好*基于文本*的形式

表示层：
- 数据的表示、压缩、转换、加密
- 对标HTTP *Accept-Encoding*与SSL/TLS

会话层
- 提供会话功能（比如IP电话、视频）
- 对标RTMP、RTP等流媒体传输协议

传输层（运输层）：
- 提供*进程与进程*之间的通信
- 传输单位为Segment（报文段）
- TCP、UDP
- 这一层的TCP可以提供*有连接*、*有确认*的*可靠传输服务*

网络层（网际层）：
- 提供*主机与主机*之间在*互连网络*中的通信
- 传输单位为Datagram（数据报）
- 最重要的功能其实是**路由选择**
- IP协议的提供的服务是*无连接*的*不可靠服务（尽最大努力交付服务）*
- 协议：
  - 代表性协议是*IP*
  - 路由选择协议
    - RIP
    - OSPF
    - BGP
  - ICMP
- IP协议实际上是因特网协议族的最底层，**物理网络层不属于因特网协议族**。这是因为**IP协议连接的物理网络的各个子网可以是异构的**，或者说互连网络连接的各个子网可以采用不同的链路层协议和物理层协议

数据链路层：
- 提供主机与主机之间在*直连网络*中的通信
- 传输单位为Frame（帧）
- 负责数据的校验
- 协议：
  - PPP（点到点）
  - Ethernet（多路访问网络）
  - ARP（基于MAC地址的链路层通信）

### Concepts
- SAN, LAN, MAN, WAN
  
  SAN: System Area Network
  
- Internet
  
  Internet = Host + Link + Router

- PDU, SDU, PCI, SAP
  - PDU: Protocol Data Unit，也即包（Packet）
  - SDU: Service Data Unit; PCI: Protocol Control Information，一般作为header
  - PDU = PCI + SDU
  - SAP: Service Access Point

- 时延：
  - 处理时延：与路由器处理性能有关
  - 排队时延：与拥塞有关
  - 传输时延：与通信链路带宽有关
  - 传播时延：
    - 与通信介值、通信距离有关
    - 注意**光纤的传播时延大于铜线**

## 信道复用

- Multiplex
  - FDM: Frequency Division Multiplex
  - TDM/WDM: Time/Wave Division Multiplex
  - CDM: Code Division Multiplex (3G: CDMA)
  - Statistical Multiplex

- Switching
  - Circuit Switching: FDM,TDM,CDM, Telephone 
  - **Packet Switching**: Statistical Multiplex, Computer Network

## 数据链路层

提供在**直连网络**上节点之间的通信服务

四个主要功能：
- framing 形成帧
  - 在header中包含校验码、地址、和SAP（指名帧的上层协议）
- error detect 差错检验、纠错
- error control 发现丢包、重复、错序、溢出，提供流量控制
  - 注：这些特性用于提供可靠传输服务，但并不是所有的链路层协议都提供可靠传输服务的，所有这些功能不一定有（互联网络中的可靠传输服务由TCP提供，毕竟IP协议是不可靠传输协议）
- medium access control 介值访问控制
  - 用于处理多路访问网络（比如以太网）中的碰撞问题

### Error Detect
- Parity 奇偶校验码
  - 保证传输比特和校验位中1的个数为偶数/奇数（偶校验/）
  - 可以将原始的包数据排列成二维矩阵，然后采用二维的奇偶校验码即可实现检错和一位纠错
  - 可以拓展为*海明码*
- CheckSum 检验和
  - 利用加法器，将传输比特流分段相加再取反得到校验和
  - 加法过程中的进位还要单独加一次
  - 传输比特+校验和得到全1码
  - 由于依赖加法，且是弱校验，一般不用于链路层，而是用于网络层和传输层
- CRC 循环冗余校验
  - 利用*生成多项式*和*模2除法*实现
  - 硬件实现简单高效
  - 检错率很高

### Reliable Data Transfer (Link ver.)
需要分类讨论：点到点和多路访问网络。因为点到点网络的情形相对简单：不会原生出现重复、错序和碰撞，主要会发生丢包错误

点到点：
- 接收方使用序号来发现中间的丢包（由于点到点网络不会错序到达，所有中间确实的编号必然是丢了）
- 接收方收到的包检验出错（且无法纠错），则丢弃该包，相当于该包丢失了
- 发送方等待接收方的*确认帧*，若某一个包没有确认，则认为该包丢失了，需要*重传*
- 由于接收方无法检出所有的丢包（比如序号最后的连续若干个包丢失），所以不能简单地等待接收方对所有发出的包进行确认
- 正确的做法是为每个发送的帧设置*超时计时器*，一旦超时视为丢包，进行**超时重传**
- ARQ：自动重传
  - 两种策略：停止等待协议，连续确认协议
  - 停止等待协议
    - 每次发送一帧，然后等待确认，发送成功收到确认才发送下一帧，否则重传
    - 较简单，但效率非常低，因为必须等待确认才能发送下一帧（尤其是在传播时延较大的信道）
  - 可能出现的问题&解决方案
    - 帧丢失/帧校验出错
      
      发送方超时重传，接收方等待重传
  
    - 确认帧丢失
      
      发送方超时重传，接收方收到重复帧（丢弃重复），发出重复确认
  
    - 帧迟到/确认帧迟到
      
      发送方超时重传，接收方收到重复帧（丢弃重复），发出重复确认（丢弃重复），发送方收到重复确认
- 连续ARQ

  连续ARQ是指可以连续发送多个帧，不必等待确认

  - 滑动窗口协议
    - 发送窗口：通过划定发送方连续传输的最大边界来实现流量控制
    - 当发送窗口中的帧得到确认时可以将窗口右移，表示后续的帧可以继续发送了
    - 一般采用*累计确认*的方法，即收到确认号n表示序号n及其之前的全部帧都已收到
  
  若第n帧丢失，但n+1帧开始正常收到（也即*错序到达*），有两种策略：

  - Go Back N

    第n帧丢失，则从第n帧开始重传（尽管n+1帧以后的已经收到了），然后丢弃重复收到的帧

  - Selective Repeat

    增加否定性确认确认帧（NAK），表示n之前的全部帧都已收到，但第n帧丢失了。

    发现这种丢失时，接收方暂存错序到达的帧，并发送NAK

    在这种策略下，超时时间将适当增大（比如2RTT），只重传丢失的帧，并最终在收到适合的累积确认ACK后避免重传n+1开始错序到达的帧

    在信道较差的情况下，这种策略会有负面影响（超时时间增大，重传延迟）

    为了暂存错序到达的帧，接收方需要接收窗口

    注意，在该策略下接收窗口大小<=发送窗口
  
  改进滑动窗口：
  - SACK 选择确认：选择错序到达的帧进行确认，减少重传
  - Delay ACK 延迟确认：在接收到一帧后不立即发确认，等一段时间再发确认。由于基于累计确认机制，可以少发一些ACK
  - 捎带确认。由于是全双工通信，在接收方发数据的同时捎带上ACK

### PPP
PPP = Point-to-Point Protocol

PPP协议是一种用于**点到点网络**的数据链路层协议。

PPP提供的是**不可靠传输服务**

PPP数据帧
```
  标志 地址 控制 协议 数据 校验码 标志
```
- 标志规定是0x7E
- 地址固定为0xFF, 控制固定为0x03


透明传输问题：
- 作为链路层协议，PPP帧的定界依赖帧开头和结尾的**0x7E标志**。但是SDU中有可能本来就有0x7E，故为了实现*透明传输*，需要对SDU数据中的0x7E来进行*转义*

PPP协议的协商：

PPP协议允许通信双方对通信细节进行“协商”

### NIC

NIC(Network Interface Card)，网络接口卡，俗称“网卡”。

链路层主要通过NIC及其驱动程序来实现的。

### 多路访问网络&介值访问控制协议

多路访问链路也称广播链路，指一组主机共享同一传输介质。广播链路的好处是节省线材，容易支持广播；缺点是一旦有多台主机同时发送会导致链路中的信号相互干扰，称为*碰撞*

为了解决广播链路的冲突问题，一些专门由于处理广播链路冲突的协议称为**MAC(Media Access Control)**协议

目前，在多路访问链路中常将数据链路层细分为*LLC(Logic Link Communication)*层和*MAC(Media Access Control)*层

最著名的的多路访问网络协议是**以太网(Ethenet)**

Slotted：一种MAC策略，规定将时间分为若干等长的片，称为“槽（slot）”。帧只能在slot的开始发送，也即*将发送时机同步到slot起始时刻*.可以证明这一策略能提高效率减少碰撞。

历史上曾经出现过Slotted ALOHA协议，不进行载波监听直接发送，冲突则重传，效率是较一般的。

CSMA
- CSMA = Carrier Sense Multiple Access 载波监听多路访问
- 这是一种MAC策略，是指**发送前，需要监听信道是否空闲**
- 几种具体的CSMA：
  -  1-persistent CSMA （以太网采用）
     
     发送前先监听信道，信道空，立即发送；否则持续监听，直到信道空，立即发送
  
  -  non-persistent CSMA （常见于低功耗的场景）
     
     (1) 发送前先监听信道，信道空，立即发送；(2) 否则延迟一段随机长度的时间，转(1)
  
  - p-persistent CSMA

    类似1-persistent CSMA，但是在信道空的时候以概率p发送（区别于以概率1发送）

CSMA/CD协议
- 全称 Carrier Sense Multiple Access / Collision Detection
- 是以太网使用的MAC协议
- **CSMA/CD基本流程**：
  - 1-persistent CSMA, 信道空立即发送，否则持续监听至信道空再发送
  - 边发送边检测冲突，如果发送完毕都没有检测到冲突，则发送成功
  - 若发送时检测到冲突，则停止发送并发送32bit干扰位加强冲突信号
  - 冲突发生时采用*二进制指数退避算法*随机延迟一段时间再回到1-persistent
- 监听信道的时候，必须要有一段连续时间的空闲才能算空闲。比如96b。
- 二进制指数退避算法
  
  基本做法：在第$i$次冲突时随机延迟$k$个时间片，其中$k\in Z$从区间$[0, 2^{\min(i, 10)}-1]$中随机选取。
  
  注意：
  - 第10次之后不再增大选取范围，因此该算法也称*截断式*二进制指数退避算法
  - 第16次冲突之后将不再重试，直接向上层返回发送失败。

  第$i$次冲突概率：
  $$
    \begin{cases}
    \frac{1}{2^{i-1}},\ i \le 10\\
    \frac{1}{2^9},\ i > 10
    \end{cases}
  $$

  冲突次数期望：
  $$
    0.64左右
  $$

### 以太网
以下内容为10Mbps以太网协议的规定


以太网MAC帧格式
```
  前导字符 目的地址 源地址 类型/长度 有效载荷 帧校验序列
```
- 前导字符包括7B的*同步字符*和1B的*起始定界符*，这一部分可以不视为帧的一部分
- 目的地址就是MAC地址
- 源地址也是MAC地址
- “类型/长度”字段
  - 该字段存在历史包袱
    - DIXv2格式：最初的格式，在该格式中该字段表示“类型”
    - 802.3帧（原）：该字段表示“长度”
    - 802.3帧（1997年修订）：也是现在的格式，表示类型/长度
  - 该字段原本表示的是上层协议类型，即SAP
  - 但有效载荷是变长的，且*最小长度是46B，不足的字节会填充*，不得不使用该字段表示有效载荷的真实长度
  - 但幸好，表示SAP的数值都大于1500（有效载荷最大长度）
  - 综上，使用如下表示规则：
    - 若该字段大于1500，则将其解释为SAP
    - 若该字段不足1500，则将其解释为有效载荷实际长度
    - 但这一策略仍然有问题：当类型/长度字段表示长度时将无法表示SAP。解决方案是增加抽象层次，拓展帧格式，在有效载荷中继续添加header以表示SAP
  - 实际上，目前的网卡实现基本都不会将该字段解释为长度，基本用不到那个复杂的拓展格式。也即**现在的以太网实现总是将“类型/长度”字段解释为SAP**，**由上层协议保证帧有效载荷长度不小于1500**
- 帧校验序列是CRC-32

关于以太网MAC地址：
  - MAC地址6B，分为三种：单播地址、多播地址、广播地址
  - 单播地址也称物理地址，一个网卡需要绑定唯一的MAC单播地址（网卡出厂时厂商保证MAC地址唯一）。但实际上网卡的MAC地址可以更改，且只需要在同一以太网中唯一即可。
  - 广播地址全1
  - 由于以太网实际上是广播信道，以太网网卡是会接收所有正确的帧的，对于单播/多播，网卡检查目标地址是否符合，

最短帧问题
- 问题出在以太网*边发送边检测冲突*，换句话说*不发送不检测冲突*。
- 由于传播时延，一个节点从发送到其冲突传播回到节点**至多需要2RTT**。为了保证当冲突到达发送端的时候发送端仍在检测冲突（也即*仍在发送*），必须根据网络带宽设置*最小有效载荷长度*，从而保证*最小帧长度*，保证在2RTT之内节点仍在发送。以10Mbps以太网为例，2RTT约等于51.2微秒，对应的最小帧长度是64B

**争用窗口**：
- 使用符号$\tau$表示
- 通常$\tau=2\mathrm{RTT}$。
- 争用窗口的意义是：若信道空闲，某主机准备发送数据，则在长度$\tau$的时间内，是有可能与其他节点产生冲突的。通俗地说，这一窗口内有可能出现相互*争用*信道导致冲突。
- 一般CSMA/CD的退避算法的延迟时间片也是$\tau$。这是因为如果退避时间片小于争用窗口



### 以太网的物理设备
- 最初的同轴电缆
  
  这种方案是真正意义上的完全共用物理介值。

  一台主机故障，整个网络的无法工作。早已淘汰。

- 集线器

  这种设备的行为就是简单地模拟同轴电缆总线的功能：收到信号立刻转发至所有其他线路，收到冲突则转发冲突。

  **集线器没有存储转发的功能**。从这一意义上说，集线器工作在物理层上（面向比特传输）。

  **集线器的所有接口共用同一个冲突域**。也即集线器连接的任何两个同时发送则会冲突。

  现已很少用了

- 交换机
  
  - **交换机具有存储转发的功能**
  - 交换机的各个端口**各自属于不同的冲突域**。这是因为交换机能够存储转发，检查目标地址，只将帧转发到合适的端口，故端口之间不会冲突

### 扩展局域网&透明网桥
- 用*网桥*连接若干个LAN可以建造一个更大的LAN，称为桥接局域网或者扩展局域网。
- 原来的局域网称为扩展局域网的一部分，称为该局域网的一个网段（Segment）

  其实“网段”有多种定义，此处取如下定义：

  **共享同一个冲突域的局域网称为一个网段**

- 由于网桥对局域网的拓展对主机是不可见的，换句话说，对于主机来讲拓展局域网仍然是一个局域网，具有统一的操作接口和协议。因此这样对主机透明的网桥设备也称为*透明网桥*
- 网桥工作在链路层，因为网桥面向帧进行工作。
- 网桥具有*一个*MAC地址，可以认为它是同时连接多个局域网的特殊主机
- 网桥对应的产品恰恰是**交换机**
- 网桥的三种操作
  - flood：若某一网段的主机*广播*信息，网桥广播其发送帧到所有端口，同时**不能将其发回发送信息的网段本身**，因此这一操作并不是真正的广播，称为泛洪（flood）
  - forward：若某一网段的主机*单播*信息，且目标主机是*另一个网段*的，则网桥需要将信息转发（forward）目标主机所在的端口。
  - filter：若某一网段的主机单播信息，且目标主机是*同一网段*的，则网桥不做任何转发操作，简单地过滤（filter）掉或者说丢弃（discard）收到的帧即可。
- 网桥需要维护一个表记录各个主机所在网段，该表称为转发表。
- 转发表的*自学习*
  - 转发表具有*自学习*特性，每次主机发送帧的时候根据帧的源地址字段，自动记录该主机所属网段
  - 新入网的主机可能在转发表中没有记录，若此时有主机向该新入网主机的发送信息，网桥会直接flood该帧
  - 由于网络拓扑结构可能会变化（比如一台已经有记录的主机从一个网段转移至另一个网段），转发表的记录可能会*过期*。因此网桥会为每一条记录设置TTL（生存时间）。当记录过期时，网桥将该记录删除。
  - 因此，完整的网桥自学习策略是：
    - 当收到一帧，若源地址没有记录，则添加转发表记录；若源地址对应记录已存在，则**更新转发表记录，重置TTL**
    - 当一条记录超时了，删除该记录
  - 实际上，由于实际的网络中的主机总是在发送帧，这一策略往往可以保证转发表对网络的拓扑结构是最新的。
- 多网桥与广播风暴
  
  考虑多个网桥构造的有环的网络链路拓扑结构。若网段1的主机发一帧给一台在网段2中的不在转发表中的主机，网桥1先收到这一帧后，只能使用flood操作向网段2广播。flood操作之后，链路有环，网桥2收到来自网段2的广播后，也需要flood，在网段1中广播一帧。此时网桥1在网段1中又收到了一帧，再次向网段2广播。如此反复，导致局域网中无休止地传输同一帧。这一现象称为*广播风暴*

  广播风暴的根源是链路的拓扑结构中有回路

  解决广播风暴的最直接方法是新加入的目的主机随便发送一帧。这样就可以更新所有网桥的转发表。有了转发表的记录，以该主机为目的主机的单播帧不再需要flood而是forward，从而消除了广播风暴。

  更系统的方法是将网络拓扑结构简化为*生成树*

- 生成树协议
  - Bridge ID（BID）由2B的“优先权”（默认都是32769）和6B的网桥MAC地址构成。
  - 我们规定，**BID最小的节点是根网桥**
  - 利用配置消息BPDU来建立生成树
    - BPDU包含当前根BID，到根的距离，发送BID，发送端口
    - 一开始，所有的网桥以自己为根向其相邻网桥发送BPDU帧。
    - 一轮发送后，所有节点都会收到相邻节点的BPDU帧。根据收到的BPDU，若发现收到的BPDU*优于*自己，则调整策略，认为该较小的BID才是根，并以此结论为基准发送新的BPDU
    - 在若干轮BPDU多播之后，最终只有局域网中BID最小的网桥才被公认为根，且所有网桥都可以计算出到根网桥的最短
    - 所谓“优”，是指对BPDU的`<根桥ID，根开销，发送桥ID，发送端口>`按照字典序比较，字典序较小的BPDU视为“更优”的BPDU
      - 也即先比较根桥ID，较小者为更优
      - 根桥ID相同，根开销较小者更优
      - 根桥ID相同，根开销相同，发送桥ID较小者更优
      - 根桥ID相同，根开销相同，发送桥ID相同，发送端口较小者更优
  - 每个端口选择到根网桥的最短路所走的端口进行转发。称此端口称为*根端口*
  - 每个网段只匹配距离根最近的网桥，该网段连接该网桥的端口称为该网段的*指定端口*
  - **数据帧只能通过根端口和指定端口进行通信**。既不是跟端口又不是指定端口称为阻塞端口。
  - 拓展思考：为什么简单地使用BFS构造生成树。原因是这些节点没有共享存储器，通信完全依赖消息。也即，如果将局域网系统是*不共享内存*的*对称多处理*系统，所以采用的算法可说是*分布式算法*，因此不能简单地使用BFS

### 虚拟局域网
与扩展局域网相反，扩展局域网试图利用网桥将在物理上分离的多个局域网连接在一起，虚拟局域网（VLAN）试图**将在物理上相连的多个主机分离成多个虚拟的逻辑上独立的局域网**。主要实现手段就是为网桥的各个端口配置VLAN ID，帧只在VLAN ID相同的端口之间通信。

若同一个VLAN的主机连在多个不同网桥的上，则必须允许网桥之间的连接能转发VLAN ID不同的帧。称网桥之间的链路端口为*Trunk端口*。实际上，只有在Trunk端口上传输的帧才需要加VLAN ID

VLAN改动了协议头部，但仍然可以采用以太网，且可以不改动以太网帧结构：令类型字段使用0x8100取值，然后扩充的字段放到有效载荷部分。

### 交换机

交换机基本构成和原理是：
- 多个端口，每个端口配置一个缓冲区（用于存储转发、排队）
- 使用*交换结构*（Switching Fabrics）来进行端口之间的数据交换

几种常见的交换结构
- 总线式：端口共享一根总线，使用某高速总线协议来交换数据，有点是价格低廉
- 纵横式：每个输入端口引一根线，然后每个输出端口都有一根线连在这根线上。性能较高，价格较贵，用的较少

转发方式：
- 存储转发（Store and Forward）：交换机从端口接收到了整个帧之后再转发。这是最符合理论的操作，大部分交换机都是这种方式。
- 直通（Cut through）：收到header，解析完成后，立即逐bit转发。类似集线器的工作模式。容易证明这种方式比存储转发快。问题是可能由于争用窗口问题导致冲突
- 无碎片（Fragment free）：同直通，只不过要收到64B再转发。由于争用窗口长度，可以避免冲突。
- 适应性交换（Adaptive switching）：自适应使用采用以上三种方式中的一种。
- 实际产品中广泛使用了直通（意味着其效率提升得到实践的验证）

全双工模式：

如果交换机常常是直连主机的，则可以通过连接两对线分别用于发送和接收，来实现*全双工通信*。（注意由于是全双工通信，可以关闭CSMA/CD）

自适应：

站点周期性使用快速链路脉冲进行*协商*，自适应选择10M/100M/1000Mbps的以太网

## 网络层

### 交换技术
- 电路交换（Circuit Switch）
- 包交换（Packet Switch）
  - 虚电路
    - 交换式虚电路（暂时的）
    - 永久虚电路
    - 虚电路是有有连接的
    - 可以保证带宽
    - 虚电路基本被淘汰了。因为需要保证带宽的情形直接租用专用物理线路即可。
  - 数据报
    - 数据报是无连接的
- 两种交换技术的根本区别在于信道复用技术。
  - 电路交换采用TDM/FDM/WDM/CDMA信道复用技术
  - 包交换采用的是统计多路复用技术
- 分组交换的两种方式的根本区别在于**是否在

### IP地址
- IP地址是**全局地址，全球唯一（公网IP）**
- IP地址是**按层分配**（具有树状的子网结构）

### IP数据报

头部格式：
```
  版本(4b) 头部长度(4b)  服务类型(8b)                 总长度(16b)
             标识(16b)  未分配(1b)  DF(1b) MF(1b) 片段偏移量(13b) 
  生存期(8b)   协议(8b)  头部校验(16b)  
              源IP地址(32b)
              目的IP地址(32b)
  选项（至多40b）   填充
```

头部字段详解

1. 版本

   只用两种：IPv4和IPv6

2. 头部长度
   
   由于只有4b，因此该数值的单位是*4字节*，也即头部长度最大只有60B

   此外，4字节为单位的长度导致头部的长度必须**4字节对齐**

3. 服务类型

   最初为了指明四种服务要求（低延迟，高吞吐量、高可靠性、最小花费）和优先权。

   但实际上，这些特性都没有实现。（因为网络环境复杂，总是有数据报要求所有的服务要求和最高优先权）

4. 总长度：数据包的长度，单位是字节
5. 标识符
   
   也即包的*编号*

6. 片段偏移
   
   若IP数据包的大小超过了链路层的*最大传输单元（MTU）*（也即最大有效载荷，**不等于最长帧长度**），不得不对IP数据报*分段*
   
   - 每个分段都有自己的头部
   - 分段之后的IP数据报标识符相同。
   - 此时需要这个字段记录了各个段的**数据部分**相对于**数据部分起始位置**的偏移量
   - 此时偏移量的单位是*8字节*（因为IP数据报长度字段是16bit的，但偏移量字段只有13bit，因此是以8字节为单位）。注意，因为是8字节为单位，故划分的时候要对齐8字节。
   - 到达目的主机之后需要重组这几个分段

7. MF,DF

   由于每个片段具有独立头部，故未分段前的IP包的总长度位置，因此若最后一个片段丢失，重组时无法发现。因此需要MF（More Fragment）标志表明当前是否是最后一个片段（非最后片段：MF=1；最后片段：MF=0）

   DF（Don't Fragment）标志表示不要划分。若IP数据报长度大于MTU，又设置了DF，路由器只能丢弃该报了。


8. 生存期（TTL）
   
   使用该字段的根本目的是internet可能有环，为防止不合适的路由选择策略导致数据包无限地绕圈，路由器丢弃超出生存期的包。

   不同于物理网络不具有清除绕圈的包的能力（广播风暴），采用生成树算法解决构造合理的拓扑结构，互连网络采用TTL来定期清除绕圈的包。这其实是因为构建互连网络是不可行的。

   使用秒不实际，该TTL的单位是*跳*。
   
   **每经过一个路由器，TTL-1**。**当TTL归零时，路由器不再转发该数据报**，并且向源主机发送ICMP报文。

   TTL的取值一般是64（Linux）或者255（Windows10）。通常TTL的取值参考的是*Internet的网络图半径的两倍*
  
9.  协议
   
    该字段就是所谓的SAP，记录**上层协议**。主要的上层协议主要是TCP和UDP。

11. 头部校验
   
    使用*校验和*来校验头部。**仅校验头部**

    使用校验和有一个小效果，就是每经过一个路由器，TTL都要减1，从而头部校验也必须相应变更。但由于使用校验和，而且TTL字段是16位对齐的，因此不需要重算整个校验和，只需要相应减1即可（由于存储的是反码，实际上是+1）

11. 源IP地址
12. 目的IP地址

### 数据报分段

若IP数据包的大小超过了链路层的*最大传输单元（MTU）*（也即最大有效载荷，**不等于最长帧长度**），不得不对IP数据报*分段*
   
- 每个分段都有自己的头部
- 分段之后的IP数据报标识符相同。
- 此时需要这个字段记录了各个段的**数据部分**相对于**数据部分起始位置**的偏移量
- 此时偏移量的单位是*8字节*（因为IP数据报长度字段是16bit的，但偏移量字段只有13bit，因此是以8字节为单位）。注意，因为是8字节为单位，故划分的时候要对齐8字节。
- 到达目的主机之后需要重组这几个分段
- 若超时限时内不能收到同一个包的所有片段，则视为重组失败，丢弃该包。

由于每个片段具有独立头部，故未分段前的IP包的总长度位置，因此若最后一个片段丢失，重组时无法发现。因此需要MF（More Fragment）标志表明当前是否是最后一个片段（非最后片段：MF=1；最后片段：MF=0）

DF（Don't Fragment）标志表示不要划分。若IP数据报长度大于MTU，又设置了DF，路由器只能丢弃该报了。此时路由器一般会发一个ICMP包给源主机

DF是实现了的。DF可以用于*路径最小MTU发现*。因为根据路径最小MTU构造适当大小的IP包避免分段可以提高性能。

### IP地址

IP地址跟MAC地址都是全球分配（一般是全球唯一）的。

相比MAC地址，IP地址除了作为主机的唯一标识，还包含了表征*网络互连*的特征。更具体地说，IP地址具有*网络号*分量和*主机号*分量。这一特性使得IP是*可路由的*：某一具体主机所在的网络可以直接从IP地址中得知，因此路由只需要针对主机所在的网络就行了。

IP地址可以分成两部分：
1. **网络号**
2. **主机号**

IP地址 = 网络号:主机号

#### 有类网

传统的IP分类分5类：A类到E类

- A类：
  
  0.x.x.x ~ 127.x.x.x

  起始位为0，首字节为网络号，后3字节为主机号

  A类网络一共只有128个，但每一个网络具有非常多的主机

- B类：
  
  128.x.x.x ~ 191.x.x.x

  起始位为10，前2字节为网络号，后2字节为主机号。

  B类网络共16384个，每个网络也有不少的主机可用。

- C类：
  
  192.x.x.x ~ 223.x.x.x

  起始位110，前3字节为网络号，后1字节为主机号。

  C类网络很多，但每个网路只有至多256台主机。

- D类：
  
  224.x.x.x ~ 239.x.x.x

  起始位1110

  多播地址，不做常规使用

- E类：
  
  240.x.x.x ~ 255.255.255.255

  起始位1111

  保留，未使用

传统的有类网问题很多：
- A、B类网络的网络数目太少，网络号会迅速耗尽
- C类网络中一台主机太少了
- 不启用E类地址，使得本就紧缺的IPv4地址空间更加不够用

传统有类网不够灵活，不便于实际使用。目前有类网只是IP地址的管理机构管理地址的标准。

#### 有类网：划分子网

传统有类网不够灵活，现在采用*子网划分*的手法了配置IP地址。

将原来的网络划分为更小的*子网*，子网划分的大小可以根据实际需要连接的主机数目，因此比传统分类IP地址更灵活。

为了划分子网，从原来的主机号中划出多若干个位用于标识子网。原来的网络号拼上子网的编号，得到*子网号*

注意，我们规定：
- 类似网络号，**子网号必须唯一**。
- **主机号不能是全0或全1**
  
由于子网号是变长的，通常采用*子网掩码*来告知主机如何解释IP地址。

取IP地址“与上”子网掩码来得到子网号。

#### 无类网：构成超网

在原来的有类网上划分子网只能将原有的网络化成更小的，**划分子网无法为一个网分配更多的主机**

通过引入所谓的*无类域间路由选择协议（CIDR）*，现在允许将多个原来的有类网合并为一个更大的网，称为*超网*。

为了实现构成超网，需要*将网络号的划作主机号*。类似的，同样需要子网掩码来确定网络号。

引入构成超网之后，现在的网络号已不再具有典型的5类划分，因此*构成超网方案可以说是无类网*。

CIDR显著减少路由表中的表项数目，这一特性称为*路由聚合*。

#### 特殊的IP地址：
- 网络号是0，主机号非0：
  - 仅能用作源地址
  - 表示与目的地址处于同一网路中
- 网络号&主机号都是0：`0.0.0.0`
  - 仅能用作源地址，有两种常见含义
  - 不限制源地址（服务器监听任何来源）
  - 源地址不可知（安全考虑）
- 网络号非0，主机号为0：
  - 这不用作地址来使用，而是在理论上作为*网络号*的记号
- 网络号全0，主机号全1：
  - 这是本网络的广播地址，对应链路层的广播帧
- 网络号非0，主机号全1：
  - 向某特定网络广播的广播地址
- 私有地址：
  - 10.0.0.0 ~ 10.255.255.255（这是一个A类网）
  - 172.16.0.0 ~ 172.31.255.255 （这是16个B类网）
  - 192.168.0.0 ~ 192.168.255.255（这是256个C类网）
  - 这三个IP地址空间都是*私有地址*，**不需要向管理机构申请即可使用，不是全球唯一的，不可在公网上使用**（主干网的路由器会把这些IP作为目的地址的包滤掉）
  - 这些地址都是配合NAT使用的*专用网*地址
  - 具体用法详见NAT/NAPT部分
- 环回地址：
  - 127.0.0.1 ~ 127.255.255.254
  - 这些称为*环回地址*。这些IP都指向本机。
  - 特别地，我们通常使用127.0.0.1即可
  - 默认情况下PC还会配置一个静态域名localhost，对应的就是127.0.0.1


### NAT/NAPT

实际上无论是子网划分，还是构成超网，实际上都没有拓展IPv4的地址空间：**无论如何划分，一个IP地址都只能对应一台主机**

结合私有地址，NAT协议

（待完善）

### ARP

（待完善）